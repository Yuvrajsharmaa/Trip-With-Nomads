<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Test Cascading Dropdowns</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        select {
            padding: 8px;
            width: 300px;
            display: block;
            margin-top: 5px;
        }

        #logs {
            background: #f0f0f0;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <h1>Cascading Logic Test</h1>

    <!-- MOCK TRIPS for Testing different scenarios -->
    <input type="hidden" name="trip_id" value="66d08175-8a57-4d7c-ab08-b888aa771693">

    <div class="form-group">
        <label>1. Departure Date</label>
        <select name="departure_date">
            <option value="">Select Date</option>
        </select>
    </div>

    <div class="form-group">
        <label>2. Transport</label>
        <select name="transport">
            <option value="">Select Transport</option>
        </select>
    </div>

    <div class="form-group">
        <label>3. Sharing</label>
        <select name="sharing">
            <option value="">Select Sharing</option>
        </select>
    </div>

    <h3>Logs</h3>
    <div id="logs"></div>

    <script>
        function log(msg) {
            const d = document.getElementById('logs');
            d.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            console.log(msg);
        }

        // --- MOCK COMPONENT LOGIC (Mirroring DynamicDropdowns Refactor) ---
        // I will copy the core logic here to verify it works in isolation before 
        // relying on the React component which I cannot run directly here.

        // GLOBAL CACHE SIM
        window['trip_cache_66d08175-8a57-4d7c-ab08-b888aa771693'] = null; // Reset

        const SUPABASE_URL = "https://jxozzvwvprmnhvafmpsa.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4b3p6dnd2cHJtbmh2YWZtcHNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNTg2NjIsImV4cCI6MjA4MzYzNDY2Mn0.KpVa9dWlJEguL1TA00Tf4QDpziJ1mgA2I0f4_l-vlOk";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function initLogic() {
            log("ðŸš€ Initializing Logic...");
            let allPricingData = [];

            const tripId = document.querySelector('input[name="trip_id"]').value;

            // FETCH
            const { data, error } = await supabase
                .from("trip_pricing")
                .select("departure_date, transport, sharing")
                .eq("trip_id", tripId);

            if (data) {
                // DATE FILTER OVERRIDE FOR TESTING (Since live dates might be past)
                // Let's pretend today is Jan 1st 2026 so we can see data
                const today = new Date("2026-01-01");

                const validRows = data.filter(row => new Date(row.departure_date) >= today);
                allPricingData = validRows;
                log(`âœ… Loaded ${validRows.length} valid rows.`);

                // POPULATE DATE
                const uniqueDates = Array.from(new Set(allPricingData.map(d => d.departure_date))).sort();
                populate('departure_date', uniqueDates);

                // EVENT LISTENERS
                const dateSelect = document.querySelector('select[name="departure_date"]');
                const transSelect = document.querySelector('select[name="transport"]');
                const shareSelect = document.querySelector('select[name="sharing"]');

                dateSelect.addEventListener('change', () => {
                    const date = dateSelect.value;
                    log(`ðŸ“… Date Selected: ${date}`);

                    // Reset Downstream
                    transSelect.innerHTML = '<option value="">Select Transport</option>';
                    shareSelect.innerHTML = '<option value="">Select Sharing</option>';

                    if (!date) return;

                    const rows = allPricingData.filter(d => d.departure_date === date);
                    const transports = Array.from(new Set(rows.map(d => d.transport))).sort();
                    populate('transport', transports);
                });

                transSelect.addEventListener('change', () => {
                    const date = dateSelect.value;
                    const trans = transSelect.value;
                    log(`ðŸš— Transport Selected: ${trans}`);

                    shareSelect.innerHTML = '<option value="">Select Sharing</option>';

                    if (!date || !trans) return;

                    const rows = allPricingData.filter(d => d.departure_date === date && d.transport === trans);
                    const sharings = Array.from(new Set(rows.map(d => d.sharing))).sort();
                    populate('sharing', sharings);
                });
            }
        }

        function populate(name, options) {
            const s = document.querySelector(`select[name="${name}"]`);
            s.innerHTML = "";
            const ph = document.createElement("option");
            ph.value = "";
            ph.text = `Select ${name}`;
            s.add(ph);

            options.forEach(o => {
                const opt = document.createElement("option");
                opt.value = o;
                opt.text = o;
                s.add(opt);
            });
            log(`Populated ${name} with ${options.length} options`);
        }

        // Auto Run
        initLogic();

    </script>
</body>

</html>